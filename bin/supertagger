#!/bin/bash

DIR=$(dirname "${BASH_SOURCE[0]}")
DIR=$(cd -P $DIR && pwd)

echo "SuperTagger was called with $*" >> /tmp/supertagger.log

function create_tags_for_single_file() {
  filename="$1"
  ext="${filename##*.}"
  if [ -e "$DIR/${ext}tagger" ]; then
    $DIR/${ext}tagger $1
  else
    ctags -f - $1
  fi
}

ROOT_PATH="."
TAGFILE=tags

function find_parent_tagfile() {
  path=''
  tagfile=tags
  while [ 1 ]; do
    abspath=`(cd ./$path; pwd)`
    if [ "$abspath" == "/" ]; then
      return
    fi

    # search for existing tags file
    if [ -e "$path$tagfile" ]; then
      TAGFILE="$path$tagfile"
      break
    fi

    # search for .git folder or Gemfile
    if [[ -d "$path.git" || -e "${path}Gemfile" ]]; then
      TAGFILE="${path}tags"
      break
    fi
    path="../$path"
  done

  ROOT_PATH=$abspath
}

function create_tags_for_directory() {

  find_parent_tagfile

  echo "Generating tags in `(cd $ROOT_PATH; pwd)`/tags"

  (
    cd $ROOT_PATH
    ctags -R --c++-kinds=+p --fields=+iaS --extra=+q --exclude=*.js -f - .
    $DIR/jstagger 
    $DIR/coffeetagger 
    $DIR/csstagger 
    $DIR/rubytagger 
  ) | sort > $TAGFILE

}

if [ "$1" != "" ]; then
  create_tags_for_single_file $1
else
  create_tags_for_directory
fi
