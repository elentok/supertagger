#!/bin/bash

selector=$1

if [ "$selector" == "" ]; then
  selector=-R\ --include\ '*.coffee'\ .
fi

function find_extended_classes() {
  grep -Hn \
    '^[ 	]*[a-zA-Z_\.0-9]\+ = *[a-zA-Z0-9_\.]\+\.extend' $selector | \
    sed -E "s/^([^:]*):([0-9]+):[ 	]*((.*\.)*)([^=\. ]*)( *= *)([^\( ]*).*$/\5	\1	\/\4\5\6\7\/;\" line:\2/"

  # 1 - filename
  # 2 - line number
  # 3 - namespace
  # 4 - namespace
  # 5 - class name
  # 6 - space ( = )
  # 7 - base class
}

function find_coffee_classes() {
  grep -Hn \
    '^[ 	]*class[ 	]\+[a-zA-Z_\.0-9]\+' $selector | \
    sed -E "s/^([^:]*):[ 	]*(class[ 	]+)((.*\.)*)([^=\. ]*)(.*)$/\5	\1	\/\2\4\5\6\/;\" /"

  # 1 - filename
  # 2 - class
  # 3 - namespace
  # 4 - namespace
  # 5 - className
  # 6 - definition
}

function find_coffee_methods() {
  grep -Hn -E \
    '^[ 	]*[a-zA-Z_\.0-9]+ *[=:] *(\([^\)]+\))? *[=-]>' $selector | \
    sed -E "s/^([^:]*):[ 	]*(.*\.)?([^=:\. ]+)( *[:=] *)(.*)$/\3	\1	\/\2\3\4\5\/;\" /"

  # 1 - filename
  # 2 - namespace
  # 3 - name
  # 4 - space
  # 5 - definition
}

function find_static_coffee_objects() {
  grep -Hn -E \
    '^[A-Z][a-zA-Z_\.0-9]* *= *$' $selector | \
    sed -E "s/^([^:]*):[ 	]*(.*\.)?([^=:\. ]+)( *=) *$/\3	\1	\/\2\3\4\/;\" /"
  
  # 1 - filename
  # 2 - namespace
  # 3 - name
  # 4 - space
  # 5 - definition
}

find_extended_classes
find_static_coffee_objects
find_coffee_classes
find_coffee_methods
